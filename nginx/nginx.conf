# Bloco de eventos, necessário para a configuração do NGINX.
events {}

# Bloco principal de configuração HTTP.
http {

    # Define um grupo de servidores para o balanceamento de carga do serviço de cursos.
    # O NGINX distribuirá as requisições entre os servidores listados aqui.
    upstream cursos_backend {
        # Instância 1 do serviço de cursos, na porta 8081.
        server servico-cursos-1:8081;
        # Instância 2 (réplica) do serviço de cursos, também na porta 8081.
        server servico-cursos-2:8081;
    }

    # Define o servidor virtual que receberá as requisições.
    server {
        # O servidor escutará na porta 80 (padrão HTTP).
        listen 80;

        # --- Rota para o Microserviço de Cursos (com Balanceamento de Carga) ---
        # Quando uma requisição chegar com o caminho começando em /api/cursos/
        location /api/cursos/ {
            # Encaminha a requisição para o grupo de servidores 'cursos_backend'.
            proxy_pass http://cursos_backend;

            # Cabeçalhos importantes para passar a informação original da requisição
            # para os serviços de backend.
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- Rota para o Microserviço de Alunos ---
        # Quando uma requisição chegar com o caminho começando em /api/alunos/
        location /api/alunos/ {
            # Encaminha a requisição diretamente para o serviço de alunos na porta 8082.
            proxy_pass http://servico-alunos:8082;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- Rota para o Microserviço de Inscrições ---
        # Quando uma requisição chegar com o caminho começando em /api/inscricoes/
        location /api/inscricoes/ {
            # Encaminha a requisição diretamente para o serviço de inscrições na porta 8083.
            proxy_pass http://servico-inscricoes:8083;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}